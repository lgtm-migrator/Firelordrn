import { getDocs } from './getDocs'
import {
	generateRandomData,
	compareWriteDataWithDocSnapData,
	initializeApp,
	userRefCreator,
	User,
} from '../utilForTests'
import { setDoc } from './setDoc'
import {
	IsSame,
	IsTrue,
	QuerySnapshot,
	QueryDocumentSnapshot,
	Query,
	DocumentReference,
} from '../types'
import { query } from '../refs'
import {
	where,
	orderBy,
	endAt,
	startAt,
	limit,
	limitToLast,
} from '../queryClauses'
import { snapshotEqual } from '../equal'

initializeApp()
const userRef = userRefCreator()
const queryTest = async (
	shareQuery: Query<User>,
	docId: string,
	data: User['write'],
	docRef: DocumentReference<User>
) => {
	await setDoc(docRef, data)
	expect.hasAssertions()
	const querySnapshot = await getDocs(shareQuery)
	type A = typeof querySnapshot
	type B = QuerySnapshot<User>
	IsTrue<IsSame<B, A>>()
	const queryDocumentSnapshot = querySnapshot.docs.filter(
		doc => doc.id === docId
	)[0]
	expect(queryDocumentSnapshot).not.toBe(undefined)
	if (queryDocumentSnapshot) {
		type X = typeof queryDocumentSnapshot
		type Y = QueryDocumentSnapshot<User>
		IsTrue<IsSame<X, Y>>()
		await compareWriteDataWithDocSnapData(data, queryDocumentSnapshot)
	}

	// test snapshotEqual

	expect(snapshotEqual(querySnapshot, querySnapshot)).toBe(true)
}

describe('test getDocs', () => {
	it('test naked query functionality and type', async () => {
		const docId = 'getDocsNakedQueryTest'
		const docRef = userRef.doc(docId)
		const data = generateRandomData()
		const shareQuery = query(userRef.collection())
		await queryTest(shareQuery, docId, data, docRef)
	})

	it('test query functionality and type with clause', async () => {
		const docId = 'getDocsWithOptionsQueryTest'
		const docRef = userRef.doc(docId)
		const data = generateRandomData()
		const shareQuery = query(
			userRef.collection(),
			where('a.b.c', '==', data.a.b.c as number)
		)
		await queryTest(shareQuery, docId, data, docRef)
	})

	it('test collection group', async () => {
		const docId = 'getDocsWithOptionsQueryTest'
		const docRef = userRef.doc(docId)
		const data = generateRandomData()
		const shareQuery = query(
			userRef.collectionGroup(),
			where('a.b.c', '==', data.a.b.c as number)
		)
		await queryTest(shareQuery, docId, data, docRef)
	})

	it('test empty array with ( in ) filter', async () => {
		const arr: number[] = []
		const shareQuery = query(
			userRef.collectionGroup(),
			where('a.b.c', 'in', arr)
		)
		const querySnap = await getDocs(shareQuery)
		expect(querySnap.docs.length).toBe(0)
	})

	it('test empty array with ( not-in ) filter', async () => {
		const arr: number[] = []
		const shareQuery = query(
			userRef.collectionGroup(),
			where('a.b.c', 'not-in', arr)
		)
		const querySnap = await getDocs(shareQuery)
		expect(querySnap.docs.length).not.toBe(0)
	})

	it('test empty array with ( array-contains-any ) filter', async () => {
		const arr: string[] = []
		const shareQuery = query(
			userRef.collectionGroup(),
			where('a.e', 'array-contains-any', arr)
		)
		const querySnap = await getDocs(shareQuery)
		expect(querySnap.docs.length).toBe(0)
	})

	it('cursor and limit test', async () => {
		const d1 = generateRandomData()
		const d2 = generateRandomData()
		const d3 = generateRandomData()
		const d4 = generateRandomData()
		const p1 = setDoc(userRef.doc('getDocsCursorTest1'), d1)
		const p2 = setDoc(userRef.doc('getDocsCursorTest2'), d2)
		const p3 = setDoc(userRef.doc('getDocsCursorTest3'), d3)
		const p4 = setDoc(userRef.doc('getDocsCursorTest4'), d4)

		await Promise.all([p1, p2, p3, p4])

		expect.assertions(5)

		const p5 = getDocs(
			query(userRef.collectionGroup(), orderBy('age'), endAt(d3.age as number))
		).then(querySnapshot => {
			const doc = querySnapshot.docs[querySnapshot.docs.length - 1]
			if (doc) {
				const data = doc.data()
				expect(data.age).toBe(d3.age)
			}
		})
		const p6 = getDocs(
			query(
				userRef.collectionGroup(),
				orderBy('age'),
				startAt(d1.age as number)
			)
		).then(querySnapshot => {
			const doc = querySnapshot.docs[0]
			if (doc) {
				const data = doc.data()
				expect(data.age).toBe(d1.age)
			}
		})

		const p7 = getDocs(
			query(userRef.collectionGroup(), limit(1), limit(4))
		).then(querySnapshot => {
			expect(querySnapshot.docs.length).toBe(4)
		})

		const p8 = getDocs(
			query(
				userRef.collectionGroup(),
				orderBy('age'),
				limitToLast(4),
				limitToLast(1)
			)
		).then(querySnapshot => {
			expect(querySnapshot.docs.length).toBe(1)
		})

		const p9 = getDocs(
			query(userRef.collectionGroup(), orderBy('age'), limit(4), limitToLast(1))
		).then(querySnapshot => {
			expect(querySnapshot.docs.length).toBe(1)
		})

		await Promise.all([p5, p6, p7, p8, p9])
	})
})
